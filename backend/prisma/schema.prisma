generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // Used for migrations with Supabase connection pooling
}

model User {
  id             String         @id @default(uuid()) @db.Uuid
  email          String?        @unique @db.VarChar(255)
  password       String?        @db.VarChar(255)
  fullName       String?        @map("full_name") @db.VarChar(255)
  phone          String?        @db.VarChar(20)
  googleId       String?        @unique @map("google_id") @db.VarChar(255)
  role           String         @default("customer") @db.VarChar(50)
  avatarUrl      String?        @map("avatar_url")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamp(6)
  lineId         String?        @unique @map("line_id") @db.VarChar(255)
  profilePicture String?        @map("profile_picture")
  // Soft Delete
  deletedAt      DateTime?      @map("deleted_at") @db.Timestamp(6)
  deletedBy      String?        @map("deleted_by") @db.VarChar(255)
  customers      Customer[]
  notifications  Notification[]

  @@index([email])
  @@index([googleId])
  @@index([lineId])
  @@index([deletedAt])
  @@map("users")
}

model Customer {
  id               String         @id @default(uuid()) @db.Uuid
  customerCode     String?        @unique @map("customer_code") @db.VarChar(50)
  userId           String?        @map("user_id") @db.Uuid
  airtableId       String?        @unique @map("airtable_id") @db.VarChar(255)
  companyName      String?        @map("company_name") @db.VarChar(255)
  contactPerson    String?        @map("contact_person") @db.VarChar(255)
  phone            String?        @db.VarChar(20)
  lineId           String?        @map("line_id") @db.VarChar(255)
  address          String?
  notes            String?
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime       @updatedAt @map("updated_at") @db.Timestamp(6)
  discount         Decimal?       @db.Decimal(5, 2)
  tier             String         @default("regular") @db.VarChar(20)
  totalSpent       Decimal?       @default(0) @map("total_spent") @db.Decimal(12, 2)
  vipSince         DateTime?      @map("vip_since") @db.Timestamp(6)
  // New fields for enhanced customer management
  profileImageUrl  String?        @map("profile_image_url")
  email            String?        @db.VarChar(255)
  taxId            String?        @map("tax_id") @db.VarChar(20)
  shippingAddress  String?        @map("shipping_address")
  billingAddress   String?        @map("billing_address")
  province         String?        @db.VarChar(100)
  postalCode       String?        @map("postal_code") @db.VarChar(10)
  country          String?        @default("Thailand") @db.VarChar(100)
  dateOfBirth      DateTime?      @map("date_of_birth") @db.Date
  preferredContact String?        @default("line") @map("preferred_contact") @db.VarChar(20)
  referralSource   String?        @map("referral_source") @db.VarChar(100)
  tags             String[]       @default([])
  isActive         Boolean        @default(true) @map("is_active")
  lastOrderAt      DateTime?      @map("last_order_at") @db.Timestamp(6)
  // Soft Delete
  deletedAt        DateTime?      @map("deleted_at") @db.Timestamp(6)
  deletedBy        String?        @map("deleted_by") @db.VarChar(255)
  user             User?          @relation(fields: [userId], references: [id])
  notifications    Notification[]
  orders           Order[]
  reviews          Review[]

  @@index([userId])
  @@index([airtableId])
  @@index([tier])
  @@index([email])
  @@index([isActive])
  @@index([deletedAt])
  @@index([companyName])
  @@index([contactPerson])
  @@index([phone])
  @@index([lineId])
  @@index([customerCode])
  @@index([createdAt(sort: Desc)])
  @@map("customers")
}

model Order {
  id                String          @id @default(uuid()) @db.Uuid
  orderNumber       String          @unique @map("order_number") @db.VarChar(50)
  trackingCode      String?         @unique @map("tracking_code") @db.VarChar(20)  // รหัสติดตามสำหรับลูกค้า (สุ่ม 8 ตัวอักษร)
  customerId        String?         @map("customer_id") @db.Uuid
  shippingMethod    String          @map("shipping_method") @db.VarChar(20)
  status            String          @default("pending") @db.VarChar(50)
  statusStep        Int             @default(1) @map("status_step")
  paymentStatus     String?         @map("payment_status") @db.VarChar(50)
  origin            String?         @db.VarChar(255)
  destination       String?         @db.VarChar(255)
  totalWeight       Decimal?        @map("total_weight") @db.Decimal(10, 2)
  totalVolume       Decimal?        @map("total_volume") @db.Decimal(10, 2)
  estimatedCost     Decimal?        @map("estimated_cost") @db.Decimal(10, 2)
  actualCost        Decimal?        @map("actual_cost") @db.Decimal(10, 2)
  estimatedDelivery DateTime?       @map("estimated_delivery") @db.Date
  notes             String?
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime        @updatedAt @map("updated_at") @db.Timestamp(6)
  // Soft Delete
  deletedAt         DateTime?       @map("deleted_at") @db.Timestamp(6)
  deletedBy         String?         @map("deleted_by") @db.VarChar(255)
  orderItems        OrderItem[]
  customer          Customer?       @relation(fields: [customerId], references: [id])
  portfolioItems    PortfolioItem[]
  reviews           Review[]
  shipments         Shipment[]

  @@index([customerId])
  @@index([orderNumber])
  @@index([trackingCode])
  @@index([status])
  @@index([statusStep])
  @@index([deletedAt])
  @@index([createdAt(sort: Desc)])
  @@index([shippingMethod])
  @@index([paymentStatus])
  @@map("orders")
}

model OrderItem {
  id               String              @id @default(uuid()) @db.Uuid
  orderId          String              @map("order_id") @db.Uuid
  sequenceNumber   Int?                @map("sequence_number")
  clickDate        DateTime?           @map("click_date") @db.Timestamp(6)
  clickChannel     String?             @map("click_channel") @db.VarChar(100)
  clickerName      String?             @map("clicker_name") @db.VarChar(255)
  customerName     String?             @map("customer_name") @db.VarChar(255)
  productCode      String?             @map("product_code") @db.VarChar(100)
  itemCode         String?             @map("item_code") @db.VarChar(100)
  trackingCode     String?             @unique @map("tracking_code") @db.VarChar(100)
  productName      String?             @map("product_name") @db.VarChar(500)
  productUrl       String?             @map("product_url")
  priceYen         Decimal?            @map("price_yen") @db.Decimal(10, 2)
  priceBaht        Decimal?            @map("price_baht") @db.Decimal(10, 2)
  itemStatus       String?             @map("item_status") @db.VarChar(100)
  paymentStatus    String?             @map("payment_status") @db.VarChar(100)
  shippingRound    String?             @map("shipping_round") @db.VarChar(100)
  trackingNumber   String?             @map("tracking_number") @db.VarChar(100)
  storePage        String?             @map("store_page") @db.VarChar(255)
  remarks          String?
  createdAt        DateTime            @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime            @updatedAt @map("updated_at") @db.Timestamp(6)
  productImages    Json?               @map("product_images")
  statusStep       Int                 @default(1) @map("status_step")
  trackingNumberJP String?             @map("tracking_number_jp") @db.VarChar(100)
  trackingNumberTH String?             @map("tracking_number_th") @db.VarChar(100)
  shippingCost     Decimal?            @map("shipping_cost") @db.Decimal(10, 2)
  weight           Decimal?            @db.Decimal(10, 2)
  // Status Detail Fields - รายละเอียดแต่ละสถานะ
  jpOrderNumber    String?             @map("jp_order_number") @db.VarChar(100)    // เลขที่ออเดอร์ญี่ปุ่น (step 3)
  jpOrderDate      DateTime?           @map("jp_order_date") @db.Date              // วันที่สั่งซื้อ JP
  warehouseDate    DateTime?           @map("warehouse_date") @db.Date             // วันที่ถึงโกดัง JP (step 4)
  shipmentBatch    String?             @map("shipment_batch") @db.VarChar(100)     // เลขตู้/เที่ยวบิน (step 5-6)
  exportDate       DateTime?           @map("export_date") @db.Date                // วันที่ส่งออกจาก JP (step 6)
  arrivalDate      DateTime?           @map("arrival_date") @db.Date               // วันที่ถึงไทย (step 7)
  courierName      String?             @map("courier_name") @db.VarChar(100)       // ชื่อขนส่งในไทย (step 8)
  deliveryDate     DateTime?           @map("delivery_date") @db.Date              // วันที่ส่งมอบ (step 9)
  statusRemarks    Json?               @map("status_remarks")                      // หมายเหตุแต่ละสถานะ {step1: "...", step2: "..."}
  // Price Lock System - ระบบล็อคราคาบาทตาม Customer Tier
  priceBahtLocked     Boolean   @default(false) @map("price_baht_locked")       // ล็อคราคาแล้วหรือยัง
  lockedTierCode      String?   @map("locked_tier_code") @db.VarChar(20)        // tier ที่ใช้คำนวณ (member/vip/vvip)
  lockedExchangeRate  Decimal?  @map("locked_exchange_rate") @db.Decimal(10, 4) // rate ที่ใช้คำนวณ
  lockedBy            String?   @map("locked_by") @db.VarChar(255)              // ชื่อคนล็อค
  lockedAt            DateTime? @map("locked_at") @db.Timestamp(6)              // เวลาที่ล็อค
  // Soft Delete
  deletedAt        DateTime?           @map("deleted_at") @db.Timestamp(6)
  deletedBy        String?             @map("deleted_by") @db.VarChar(255)
  statusHistory    ItemStatusHistory[]
  order            Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payments         Payment[]

  @@index([orderId])
  @@index([productCode])
  @@index([itemCode])
  @@index([trackingCode])
  @@index([trackingNumberJP])
  @@index([trackingNumberTH])
  @@index([trackingNumber])
  @@index([statusStep])
  @@index([deletedAt])
  @@map("order_items")
}

model Shipment {
  id              String            @id @default(uuid()) @db.Uuid
  orderId         String?           @map("order_id") @db.Uuid
  trackingNumber  String            @unique @map("tracking_number") @db.VarChar(100)
  carrier         String?           @db.VarChar(255)
  vesselName      String?           @map("vessel_name") @db.VarChar(255)
  flightNumber    String?           @map("flight_number") @db.VarChar(50)
  departurePort   String?           @map("departure_port") @db.VarChar(255)
  arrivalPort     String?           @map("arrival_port") @db.VarChar(255)
  departureDate   DateTime?         @map("departure_date") @db.Date
  arrivalDate     DateTime?         @map("arrival_date") @db.Date
  currentStatus   String?           @map("current_status") @db.VarChar(100)
  currentLocation String?           @map("current_location") @db.VarChar(255)
  latitude        Decimal?          @db.Decimal(10, 8)
  longitude       Decimal?          @db.Decimal(11, 8)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamp(6)
  order           Order?            @relation(fields: [orderId], references: [id])
  trackingHistory TrackingHistory[]

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipments")
}

model TrackingHistory {
  id          String   @id @default(uuid()) @db.Uuid
  shipmentId  String   @map("shipment_id") @db.Uuid
  status      String   @db.VarChar(100)
  location    String?  @db.VarChar(255)
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  description String?
  timestamp   DateTime @default(now()) @db.Timestamp(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  shipment    Shipment @relation(fields: [shipmentId], references: [id])

  @@index([shipmentId])
  @@index([timestamp])
  @@map("tracking_history")
}

model Schedule {
  id            String    @id @default(uuid()) @db.Uuid
  scheduleType  String    @map("schedule_type") @db.VarChar(20)
  carrier       String?   @db.VarChar(255)
  vesselName    String?   @map("vessel_name") @db.VarChar(255)
  flightNumber  String?   @map("flight_number") @db.VarChar(50)
  route         String?   @db.VarChar(255)
  departurePort String?   @map("departure_port") @db.VarChar(255)
  arrivalPort   String?   @map("arrival_port") @db.VarChar(255)
  departureDate DateTime? @map("departure_date") @db.Date
  arrivalDate   DateTime? @map("arrival_date") @db.Date
  frequency     String?   @db.VarChar(50)
  status        String    @default("active") @db.VarChar(50)
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([scheduleType])
  @@index([status])
  @@index([departureDate])
  @@index([arrivalDate])
  @@map("schedules")
}

model Review {
  id            String    @id @default(uuid()) @db.Uuid
  customerId    String?   @map("customer_id") @db.Uuid
  orderId       String?   @map("order_id") @db.Uuid
  rating        Int
  comment       String?
  isApproved    Boolean   @default(false) @map("is_approved")
  isFeatured    Boolean   @default(false) @map("is_featured")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  customerImage String?   @map("customer_image")
  customerName  String?   @map("customer_name") @db.VarChar(255)
  reviewImages  Json?     @map("review_images")  // Array of image URLs [{url: string, caption?: string}]
  customer      Customer? @relation(fields: [customerId], references: [id])
  order         Order?    @relation(fields: [orderId], references: [id])

  @@index([customerId])
  @@index([orderId])
  @@index([rating])
  @@index([isApproved])
  @@index([isFeatured])
  @@index([createdAt(sort: Desc)])
  @@map("reviews")
}

model PortfolioItem {
  id           String   @id @default(uuid()) @db.Uuid
  title        String   @db.VarChar(255)
  description  String?
  imageUrl     String?  @map("image_url")
  category     String?  @db.VarChar(100)
  orderId      String?  @map("order_id") @db.Uuid
  isFeatured   Boolean  @default(false) @map("is_featured")
  displayOrder Int?     @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  order        Order?   @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([category])
  @@index([isFeatured])
  @@index([displayOrder])
  @@index([createdAt(sort: Desc)])
  @@map("portfolio_items")
}

model RateCalculator {
  id             String   @id @default(uuid()) @db.Uuid
  shippingMethod String   @map("shipping_method") @db.VarChar(20)
  origin         String?  @db.VarChar(255)
  destination    String?  @db.VarChar(255)
  weightMin      Decimal? @map("weight_min") @db.Decimal(10, 2)
  weightMax      Decimal? @map("weight_max") @db.Decimal(10, 2)
  ratePerKg      Decimal? @map("rate_per_kg") @db.Decimal(10, 2)
  baseFee        Decimal? @map("base_fee") @db.Decimal(10, 2)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([shippingMethod])
  @@index([origin])
  @@index([destination])
  @@index([isActive])
  @@map("rate_calculator")
}

model Notification {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String?   @map("user_id") @db.Uuid
  customerId   String?   @map("customer_id") @db.Uuid
  type         String?   @db.VarChar(50)
  subject      String?   @db.VarChar(255)
  message      String?
  status       String    @default("pending") @db.VarChar(50)
  sentAt       DateTime? @map("sent_at") @db.Timestamp(6)
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  customer     Customer? @relation(fields: [customerId], references: [id])
  user         User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

model ContactMessage {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @db.VarChar(255)
  email     String    @db.VarChar(255)
  phone     String?   @db.VarChar(20)
  subject   String?   @db.VarChar(255)
  message   String
  status    String    @default("new") @db.VarChar(50)
  repliedAt DateTime? @map("replied_at") @db.Timestamp(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([email])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("contact_messages")
}

model Statistic {
  id        String   @id @default(uuid()) @db.Uuid
  statType  String   @map("stat_type") @db.VarChar(100)
  statDate  DateTime @map("stat_date") @db.Date
  value     Decimal? @db.Decimal(10, 2)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@unique([statType, statDate])
  @@index([statType])
  @@index([statDate])
  @@map("statistics")
}

model SystemSetting {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique @db.VarChar(255)
  value     Json
  category  String?  @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([category])
  @@map("system_settings")
}

model ItemStatusHistory {
  id          String    @id @default(uuid()) @db.Uuid
  orderItemId String    @map("order_item_id") @db.Uuid
  statusStep  Int       @map("status_step")
  statusName  String    @map("status_name") @db.VarChar(100)
  description String?
  changedBy   String?   @map("changed_by") @db.VarChar(255)
  timestamp   DateTime  @default(now()) @db.Timestamp(6)
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@index([statusStep])
  @@index([timestamp])
  @@map("item_status_history")
}

model Payment {
  id                String    @id @default(uuid()) @db.Uuid
  orderItemId       String    @map("order_item_id") @db.Uuid
  installmentNumber Int       @map("installment_number")
  installmentName   String?   @map("installment_name") @db.VarChar(100)
  amountYen         Decimal?  @map("amount_yen") @db.Decimal(10, 2)
  amountBaht        Decimal?  @map("amount_baht") @db.Decimal(10, 2)
  slipAmount        Decimal?  @map("slip_amount") @db.Decimal(10, 2)
  exchangeRate      Decimal?  @map("exchange_rate") @db.Decimal(10, 4)
  status            String    @default("pending") @db.VarChar(50)
  paymentMethod     String?   @map("payment_method") @db.VarChar(50)
  proofImageUrl     String?   @map("proof_image_url")
  dueDate           DateTime? @map("due_date") @db.Date
  paidAt            DateTime? @map("paid_at") @db.Timestamp(6)
  notes             String?
  verifiedBy        String?   @map("verified_by") @db.VarChar(255)
  verifiedAt        DateTime? @map("verified_at") @db.Timestamp(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)
  // Soft Delete
  deletedAt         DateTime? @map("deleted_at") @db.Timestamp(6)
  deletedBy         String?   @map("deleted_by") @db.VarChar(255)
  orderItem         OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@index([status])
  @@index([installmentNumber])
  @@index([deletedAt])
  @@map("payments")
}

// Customer Tier System - ระบบระดับลูกค้า VIP
model CustomerTier {
  id              String   @id @default(uuid()) @db.Uuid
  tierCode        String   @unique @map("tier_code") @db.VarChar(20) // member, vip, vvip
  tierName        String   @map("tier_name") @db.VarChar(100)        // Member, VIP, VVIP
  tierNameTh      String?  @map("tier_name_th") @db.VarChar(100)     // ชื่อภาษาไทย
  exchangeRate    Decimal  @map("exchange_rate") @db.Decimal(10, 4)  // อัตราแลกเปลี่ยน ¥ → ฿
  minSpent        Decimal  @default(0) @map("min_spent") @db.Decimal(12, 2)  // ยอดใช้จ่ายขั้นต่ำ
  maxSpent        Decimal? @map("max_spent") @db.Decimal(12, 2)      // ยอดใช้จ่ายสูงสุด (null = ไม่จำกัด)
  benefits        Json?                                               // สิทธิประโยชน์อื่นๆ
  color           String?  @db.VarChar(20)                           // สีสำหรับแสดง badge
  icon            String?  @db.VarChar(50)                           // icon name
  sortOrder       Int      @default(0) @map("sort_order")            // ลำดับการแสดง
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([tierCode])
  @@index([sortOrder])
  @@map("customer_tiers")
}

// Tier Change History - ประวัติการเปลี่ยนระดับลูกค้า
model TierHistory {
  id            String   @id @default(uuid()) @db.Uuid
  customerId    String   @map("customer_id") @db.Uuid
  previousTier  String?  @map("previous_tier") @db.VarChar(20)
  newTier       String   @map("new_tier") @db.VarChar(20)
  reason        String?  @db.VarChar(255)  // auto_upgrade, manual, downgrade
  totalSpentAt  Decimal? @map("total_spent_at") @db.Decimal(12, 2) // ยอดสะสม ณ เวลาเปลี่ยน
  changedBy     String?  @map("changed_by") @db.VarChar(255)       // admin email หรือ "system"
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([customerId])
  @@index([createdAt])
  @@map("tier_history")
}

// Schedule Image - รูปตารางรอบเรือ/เครื่องบินประจำเดือน
model ScheduleImage {
  id            String   @id @default(uuid()) @db.Uuid
  type          String   @db.VarChar(20)              // 'ship' หรือ 'air'
  title         String   @db.VarChar(255)             // ชื่อตาราง เช่น "ตารางเรือ ธันวาคม 2024"
  description   String?                               // รายละเอียดเพิ่มเติม
  imageUrl      String   @map("image_url")            // URL ของรูปภาพ
  month         Int                                   // เดือน (1-12)
  year          Int                                   // ปี
  isActive      Boolean  @default(true) @map("is_active")
  isNotified    Boolean  @default(false) @map("is_notified") // ส่งแจ้งเตือนแล้วหรือยัง
  notifiedAt    DateTime? @map("notified_at") @db.Timestamp(6)
  uploadedBy    String?  @map("uploaded_by") @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  @@index([type])
  @@index([month, year])
  @@index([isActive])
  @@map("schedule_images")
}

// Web Notification - การแจ้งเตือนในเว็บ
model WebNotification {
  id          String    @id @default(uuid()) @db.Uuid
  type        String    @db.VarChar(50)              // schedule_update, announcement, etc.
  title       String    @db.VarChar(255)
  message     String?
  linkUrl     String?   @map("link_url")             // ลิงก์ไปยังหน้าที่เกี่ยวข้อง
  imageUrl    String?   @map("image_url")            // รูปภาพประกอบ
  isActive    Boolean   @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at") @db.Timestamp(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([type])
  @@index([isActive])
  @@index([expiresAt])
  @@map("web_notifications")
}

// ============================================
// SECURITY & AUDIT MODELS
// ============================================

// Login History - บันทึกประวัติการ login ของ User และ Admin
model LoginHistory {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String?   @map("user_id") @db.Uuid
  userType      String    @map("user_type") @db.VarChar(20)  // 'user', 'admin'
  email         String?   @db.VarChar(255)
  loginMethod   String    @map("login_method") @db.VarChar(50)  // 'google', 'line', 'email', 'password'
  ipAddress     String?   @map("ip_address") @db.VarChar(45)    // IPv4 or IPv6
  userAgent     String?   @map("user_agent")                    // Browser/Device info
  deviceType    String?   @map("device_type") @db.VarChar(50)   // 'desktop', 'mobile', 'tablet'
  browser       String?   @db.VarChar(100)
  os            String?   @db.VarChar(100)
  country       String?   @db.VarChar(100)
  city          String?   @db.VarChar(100)
  success       Boolean   @default(true)                         // login สำเร็จหรือไม่
  failReason    String?   @map("fail_reason") @db.VarChar(255)   // เหตุผลที่ login ไม่สำเร็จ
  sessionId     String?   @map("session_id") @db.VarChar(255)    // Session/Token ID
  logoutAt      DateTime? @map("logout_at") @db.Timestamp(6)     // เวลา logout
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([userId])
  @@index([email])
  @@index([userType])
  @@index([ipAddress])
  @@index([success])
  @@index([createdAt])
  @@map("login_history")
}

// Admin Audit Log - บันทึกทุกการกระทำของ Admin
model AdminAuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  adminId       String?  @map("admin_id") @db.Uuid       // ID ของ admin ที่ทำ
  adminEmail    String   @map("admin_email") @db.VarChar(255)
  action        String   @db.VarChar(50)                  // 'create', 'update', 'delete', 'view', 'export', 'login', 'logout'
  resourceType  String   @map("resource_type") @db.VarChar(100)  // 'customer', 'order', 'payment', etc.
  resourceId    String?  @map("resource_id") @db.VarChar(255)    // ID ของ resource ที่ถูกกระทำ
  resourceName  String?  @map("resource_name") @db.VarChar(255)  // ชื่อของ resource (เช่น ชื่อลูกค้า, เลขออเดอร์)
  description   String?                                   // รายละเอียดเพิ่มเติม
  oldValue      Json?    @map("old_value")                // ค่าเดิมก่อนเปลี่ยน (สำหรับ update/delete)
  newValue      Json?    @map("new_value")                // ค่าใหม่ (สำหรับ create/update)
  changedFields String[] @default([]) @map("changed_fields")  // รายชื่อ fields ที่เปลี่ยน
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  userAgent     String?  @map("user_agent")
  requestMethod String?  @map("request_method") @db.VarChar(10)  // GET, POST, PATCH, DELETE
  requestPath   String?  @map("request_path") @db.VarChar(500)   // API path
  statusCode    Int?     @map("status_code")                     // HTTP status code
  duration      Int?                                              // Response time in ms
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([adminId])
  @@index([adminEmail])
  @@index([action])
  @@index([resourceType])
  @@index([resourceId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// Security Alert - แจ้งเตือนเหตุการณ์ผิดปกติ
model SecurityAlert {
  id            String    @id @default(uuid()) @db.Uuid
  alertType     String    @map("alert_type") @db.VarChar(50)  // 'failed_login', 'suspicious_activity', 'rate_limit', 'ip_blocked'
  severity      String    @db.VarChar(20)                      // 'low', 'medium', 'high', 'critical'
  userId        String?   @map("user_id") @db.Uuid
  userEmail     String?   @map("user_email") @db.VarChar(255)
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  description   String
  metadata      Json?                                          // ข้อมูลเพิ่มเติม
  isResolved    Boolean   @default(false) @map("is_resolved")
  resolvedBy    String?   @map("resolved_by") @db.VarChar(255)
  resolvedAt    DateTime? @map("resolved_at") @db.Timestamp(6)
  resolvedNotes String?   @map("resolved_notes")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([alertType])
  @@index([severity])
  @@index([userId])
  @@index([ipAddress])
  @@index([isResolved])
  @@index([createdAt])
  @@map("security_alerts")
}

// Data Access Log - บันทึกการเข้าถึงข้อมูลส่วนบุคคล (PII)
model DataAccessLog {
  id            String   @id @default(uuid()) @db.Uuid
  accessorId    String?  @map("accessor_id") @db.Uuid
  accessorEmail String   @map("accessor_email") @db.VarChar(255)
  accessorType  String   @map("accessor_type") @db.VarChar(20)  // 'admin', 'user', 'system'
  accessType    String   @map("access_type") @db.VarChar(50)    // 'view', 'export', 'download', 'search'
  dataType      String   @map("data_type") @db.VarChar(100)     // 'customer_info', 'payment_data', 'contact_info'
  resourceId    String?  @map("resource_id") @db.VarChar(255)
  fieldsAccessed String[] @default([]) @map("fields_accessed")  // รายชื่อ fields ที่เข้าถึง
  purpose       String?  @db.VarChar(255)                        // เหตุผลในการเข้าถึง
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([accessorId])
  @@index([accessorEmail])
  @@index([dataType])
  @@index([createdAt])
  @@map("data_access_logs")
}
