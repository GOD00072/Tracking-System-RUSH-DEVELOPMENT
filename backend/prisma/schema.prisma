// Prisma Schema for Ship Tracking System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== User Management ====================

model User {
  id             String         @id @default(uuid()) @db.Uuid
  email          String?        @unique @db.VarChar(255)
  fullName       String?        @map("full_name") @db.VarChar(255)
  phone          String?        @db.VarChar(20)
  googleId       String?        @unique @map("google_id") @db.VarChar(255)
  lineId         String?        @unique @map("line_id") @db.VarChar(255)
  profilePicture String?        @map("profile_picture") @db.Text
  role           String         @default("customer") @db.VarChar(50) // 'admin', 'customer', 'staff'
  avatarUrl      String?        @map("avatar_url") @db.Text
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamp()
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamp()

  customers      Customer[]
  notifications  Notification[]

  @@index([email])
  @@index([googleId])
  @@index([lineId])
  @@map("users")
}

model Customer {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String?   @map("user_id") @db.Uuid
  airtableId     String?   @unique @map("airtable_id") @db.VarChar(255)
  companyName    String?   @map("company_name") @db.VarChar(255)
  contactPerson  String?   @map("contact_person") @db.VarChar(255)
  phone          String?   @db.VarChar(20)
  lineId         String?   @map("line_id") @db.VarChar(255)
  address        String?   @db.Text
  notes          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp()

  user           User?     @relation(fields: [userId], references: [id])
  orders         Order[]
  reviews        Review[]
  notifications  Notification[]

  @@index([userId])
  @@index([airtableId])
  @@map("customers")
}

// ==================== Orders & Shipments ====================

model Order {
  id                String    @id @default(uuid()) @db.Uuid
  orderNumber       String    @unique @map("order_number") @db.VarChar(50)
  customerId        String?   @map("customer_id") @db.Uuid
  shippingMethod    String    @map("shipping_method") @db.VarChar(20) // 'sea', 'air'
  status            String    @default("pending") @db.VarChar(50) // 'pending', 'processing', 'shipped', 'delivered', 'cancelled'
  origin            String?   @db.VarChar(255)
  destination       String?   @db.VarChar(255)
  totalWeight       Decimal?  @map("total_weight") @db.Decimal(10, 2)
  totalVolume       Decimal?  @map("total_volume") @db.Decimal(10, 2)
  estimatedCost     Decimal?  @map("estimated_cost") @db.Decimal(10, 2)
  actualCost        Decimal?  @map("actual_cost") @db.Decimal(10, 2)
  estimatedDelivery DateTime? @map("estimated_delivery") @db.Date
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp()

  customer          Customer?        @relation(fields: [customerId], references: [id])
  shipments         Shipment[]
  reviews           Review[]
  portfolioItems    PortfolioItem[]
  orderItems        OrderItem[]

  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

// Order Items - สินค้าแต่ละชิ้นในแต่ละ Order
model OrderItem {
  id                String    @id @default(uuid()) @db.Uuid
  orderId           String    @map("order_id") @db.Uuid
  sequenceNumber    Int?      @map("sequence_number") // ลำดับที่
  clickDate         DateTime? @map("click_date") @db.Timestamp() // วัน เดือน ปี ที่กด
  clickChannel      String?   @map("click_channel") @db.VarChar(100) // ช่องทางการกด
  clickerName       String?   @map("clicker_name") @db.VarChar(255) // ชื่อคนกด
  customerName      String?   @map("customer_name") @db.VarChar(255) // ชื่อลูกค้า
  productCode       String?   @map("product_code") @db.VarChar(100) // รหัสสินค้า
  productUrl        String?   @map("product_url") @db.Text // ลิ้งค์สินค้า
  priceYen          Decimal?  @map("price_yen") @db.Decimal(10, 2) // ราคาเยน
  priceBaht         Decimal?  @map("price_baht") @db.Decimal(10, 2) // ราคาบาท
  itemStatus        String?   @map("item_status") @db.VarChar(100) // สถานะของ
  paymentStatus     String?   @map("payment_status") @db.VarChar(100) // สถานะการจ่ายเงิน
  shippingRound     String?   @map("shipping_round") @db.VarChar(100) // รอบส่งกลับ
  trackingNumber    String?   @map("tracking_number") @db.VarChar(100) // Tracking
  storePage         String?   @map("store_page") @db.VarChar(255) // เพจ/ร้าน
  remarks           String?   @db.Text // หมายเหตุ
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp()

  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productCode])
  @@index([trackingNumber])
  @@map("order_items")
}

model Shipment {
  id              String    @id @default(uuid()) @db.Uuid
  orderId         String?   @map("order_id") @db.Uuid
  trackingNumber  String    @unique @map("tracking_number") @db.VarChar(100)
  carrier         String?   @db.VarChar(255)
  vesselName      String?   @map("vessel_name") @db.VarChar(255) // For sea shipping
  flightNumber    String?   @map("flight_number") @db.VarChar(50) // For air shipping
  departurePort   String?   @map("departure_port") @db.VarChar(255)
  arrivalPort     String?   @map("arrival_port") @db.VarChar(255)
  departureDate   DateTime? @map("departure_date") @db.Date
  arrivalDate     DateTime? @map("arrival_date") @db.Date
  currentStatus   String?   @map("current_status") @db.VarChar(100)
  currentLocation String?   @map("current_location") @db.VarChar(255)
  latitude        Decimal?  @db.Decimal(10, 8)
  longitude       Decimal?  @db.Decimal(11, 8)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamp()

  order           Order?            @relation(fields: [orderId], references: [id])
  trackingHistory TrackingHistory[]

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipments")
}

model TrackingHistory {
  id          String   @id @default(uuid()) @db.Uuid
  shipmentId  String   @map("shipment_id") @db.Uuid
  status      String   @db.VarChar(100)
  location    String?  @db.VarChar(255)
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  description String?  @db.Text
  timestamp   DateTime @default(now()) @db.Timestamp()
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp()

  shipment    Shipment @relation(fields: [shipmentId], references: [id])

  @@index([shipmentId])
  @@index([timestamp])
  @@map("tracking_history")
}

// ==================== Schedules ====================

model Schedule {
  id            String    @id @default(uuid()) @db.Uuid
  scheduleType  String    @map("schedule_type") @db.VarChar(20) // 'sea', 'air'
  carrier       String?   @db.VarChar(255)
  vesselName    String?   @map("vessel_name") @db.VarChar(255)
  flightNumber  String?   @map("flight_number") @db.VarChar(50)
  route         String?   @db.VarChar(255)
  departurePort String?   @map("departure_port") @db.VarChar(255)
  arrivalPort   String?   @map("arrival_port") @db.VarChar(255)
  departureDate DateTime? @map("departure_date") @db.Date
  arrivalDate   DateTime? @map("arrival_date") @db.Date
  frequency     String?   @db.VarChar(50) // 'weekly', 'biweekly', 'monthly'
  status        String    @default("active") @db.VarChar(50) // 'active', 'cancelled', 'delayed'
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamp()

  @@map("schedules")
}

// ==================== Reviews & Portfolio ====================

model Review {
  id            String   @id @default(uuid()) @db.Uuid
  customerId    String?  @map("customer_id") @db.Uuid
  customerName  String?  @map("customer_name") @db.VarChar(255)
  customerImage String?  @map("customer_image") @db.Text
  orderId       String?  @map("order_id") @db.Uuid
  rating        Int      // 1-5
  comment       String?  @db.Text
  isApproved    Boolean  @default(false) @map("is_approved")
  isFeatured    Boolean  @default(false) @map("is_featured")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp()

  customer      Customer? @relation(fields: [customerId], references: [id])
  order         Order?    @relation(fields: [orderId], references: [id])

  @@index([customerId])
  @@index([isApproved])
  @@map("reviews")
}

model PortfolioItem {
  id           String   @id @default(uuid()) @db.Uuid
  title        String   @db.VarChar(255)
  description  String?  @db.Text
  imageUrl     String?  @map("image_url") @db.Text
  category     String?  @db.VarChar(100)
  orderId      String?  @map("order_id") @db.Uuid
  isFeatured   Boolean  @default(false) @map("is_featured")
  displayOrder Int?     @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp()

  order        Order?   @relation(fields: [orderId], references: [id])

  @@map("portfolio_items")
}

// ==================== Rate Calculator ====================

model RateCalculator {
  id             String   @id @default(uuid()) @db.Uuid
  shippingMethod String   @map("shipping_method") @db.VarChar(20) // 'sea', 'air'
  origin         String?  @db.VarChar(255)
  destination    String?  @db.VarChar(255)
  weightMin      Decimal? @map("weight_min") @db.Decimal(10, 2)
  weightMax      Decimal? @map("weight_max") @db.Decimal(10, 2)
  ratePerKg      Decimal? @map("rate_per_kg") @db.Decimal(10, 2)
  baseFee        Decimal? @map("base_fee") @db.Decimal(10, 2)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamp()

  @@map("rate_calculator")
}

// ==================== Notifications & Contact ====================

model Notification {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String?   @map("user_id") @db.Uuid
  customerId   String?   @map("customer_id") @db.Uuid
  type         String?   @db.VarChar(50) // 'email', 'line', 'sms'
  subject      String?   @db.VarChar(255)
  message      String?   @db.Text
  status       String    @default("pending") @db.VarChar(50) // 'pending', 'sent', 'failed'
  sentAt       DateTime? @map("sent_at") @db.Timestamp()
  errorMessage String?   @map("error_message") @db.Text
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp()

  user         User?     @relation(fields: [userId], references: [id])
  customer     Customer? @relation(fields: [customerId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("notifications")
}

model ContactMessage {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @db.VarChar(255)
  email     String    @db.VarChar(255)
  phone     String?   @db.VarChar(20)
  subject   String?   @db.VarChar(255)
  message   String    @db.Text
  status    String    @default("new") @db.VarChar(50) // 'new', 'read', 'replied'
  repliedAt DateTime? @map("replied_at") @db.Timestamp()
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp()

  @@map("contact_messages")
}

// ==================== Statistics ====================

model Statistic {
  id        String   @id @default(uuid()) @db.Uuid
  statType  String   @map("stat_type") @db.VarChar(100)
  statDate  DateTime @map("stat_date") @db.Date
  value     Decimal? @db.Decimal(10, 2)
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()

  @@unique([statType, statDate])
  @@map("statistics")
}

// ==================== System Settings ====================

model SystemSetting {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique @db.VarChar(255)
  value     Json     @db.JsonB
  category  String?  @db.VarChar(100) // 'line', 'calculator', 'company', etc.
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp()

  @@index([category])
  @@map("system_settings")
}
